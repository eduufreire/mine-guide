<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mine Guide - Usuário</title>

    <link rel="shortcut icon" href="../assets/icons/icon-mine-guide.ico" type="image/x-icon">
    <link rel="stylesheet" href="../css/style-scrollbar.css">
    <link rel="stylesheet" href="../css/style-page-user.css">

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.1.1/model-viewer.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

</head>

<body>

    <nav>
        <div class="container">

            <div class="logo">
                <a href=""><img src="../assets/img/icon-mine-guide.png" alt=""></a>
            </div>

            <div class="links">
                <a href="#container-dicas">
                    DICAS
                </a>

                <a href="#container-graficos">
                    GRÁFICOS
                </a>

                <a onclick="logout()">
                    <img src="../assets/icons/icon-sair.png" alt="" id="icon-navbar">
                </a>
            </div>

        </div>
    </nav>

    <div class="user-info">
        <div class="container">
            <div class="container-info">

                <div class="image">
                    <img src="../assets/img/raposa-info.png" alt="">
                </div>

                <div class="box-info">
                    <div class="text">
                        <div class="title">
                            <h3>Estatísticas do jogador:</h3>
                        </div>

                        <div class="texts">
                            <p>User: <span id="spanUser"></span> </p>
                            <p>Plataforma: <span id="spanPlat"></span> </p>
                            <p>Nível: <span id="spanNivel"></span> </p>
                            <p>Última visita: <span id="spanData"></span> </p>
                        </div>
                    </div>

                    <div class="rank">
                        <div class="background">
                            <img src="" alt="" id="imgNivel">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>


    <div class="data-players">
        <div class="container">

            <div class="content">

                <div class="title">
                    <h1>PERC. PLAYERS POR NÍVEL</h1>
                    <h3>Total: <span id="totalPlayerBlog"></span></h3>
                </div>

                <div class="cards">

                    <div class="card">
                        <div class="title">
                            <h2>COURO</h2>
                        </div>

                        <div class="percent">
                            <h2 id="percCouro"></h2>
                        </div>

                    </div>


                    <div class="card">
                        <div class="title">
                            <h2>FERRO</h2>
                        </div>

                        <div class="percent">
                            <h2 id="percFerro"></h2>
                        </div>

                    </div>

                    <div class="card">
                        <div class="title">
                            <h2>DIAMANTE</h2>
                        </div>

                        <div class="percent">
                            <h2 id="percDiamante"></h2>
                        </div>

                    </div>

                    <div class="card">
                        <div class="title">
                            <h2>NETHERITE</h2>
                        </div>

                        <div class="percent">
                            <h2 id="percNetherite"></h2>
                        </div>

                    </div>
                </div>

            </div>

        </div>
    </div>


    <div class="dicas" id="container-dicas">
        <div class="container">

            <div class="title">
                <h1>DICAS</h1>
            </div>


            <div class="container-cards" id="containerCard">




            </div>

            <div class="button-random">
                <button onclick="atualizarDicas()">EMBARALHAR</button>
            </div>

        </div>
    </div>


    <div class="graphics" id="container-graficos">
        <div class="container">


            <div class="container-card">

                <div class="content-graph">

                    <div class="title">
                        <h2>PLAYERS POR NÍVEL</h2>
                    </div>

                    <div class="charts">
                        <canvas id="chartNivel"></canvas>
                    </div>

                </div>

                <div class="image-3d one">
                    <model-viewer class="model-3d" src="../assets/3d-model/fox_minecraft.glb"
                        ar-modes="webxr scene-viewer quick-look" camera-controls poster="poster.webp" autoplay>
                    </model-viewer>
                </div>
            </div>

            <div class="container-card reverse">

                <div class="content-graph">

                    <div class="title">
                        <h2>PLAYERS POR PLATAFORMA</h2>
                    </div>

                    <div class="charts">
                        <canvas id="chartPlataforma"></canvas>
                    </div>

                </div>

                <div class="image-3d two">
                    <model-viewer class="model-3d" src="../assets/3d-model/minecraft_pickaxe.glb"
                        ar-modes="webxr scene-viewer quick-look" camera-controls poster="poster.webp" autoplay>
                    </model-viewer>
                </div>
            </div>


        </div>
    </div>

    <footer>
        <div class="container">

            <div class="logo">
                <a href=""><img src="../assets/img/icon-mine-guide.png" alt=""></a>
                <p>Mine Guide © 2023</p>
            </div>

            <div class="links">
                <a href="">
                    INÍCIO
                </a>

                <a href="index.html#about-game">
                    JOGO
                </a>

                <a href="about.html">
                    SOBRE
                </a>

                <a href="index.html#sugestoes">
                    SUGESTÕES
                </a>
            </div>

            <div class="social-links">
                <a href="">
                    <img src="../assets/icons/icon-insta.png" alt="">
                </a>

                <a href="">
                    <img src="../assets/icons/icon-zap.png" alt="">
                </a>

                <a href="">
                    <img src="../assets/icons/icon-gmail.png" alt="">
                </a>
            </div>

        </div>
    </footer>


</body>

</html>

<script src="../js/config-toast.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    window.load = validarSessao()
    function validarSessao() {
        if (sessionStorage.idPlayer == null || sessionStorage.nickPlayer == null) {
            window.location = "../index.html";
            setTimeout(() => {
                sessionStorage.clear();
            }, 2000)
        }
    }


    var nivelSession = sessionStorage.fkNivel
    var idSession = sessionStorage.idPlayer

    window.load = listarDica(idSession, nivelSession)
    window.load = dadosPlayersBlog()


    // RECUPERANDO VALORES DO LOGIN
    spanUser.innerHTML = `${sessionStorage.nickPlayer}`
    spanPlat.innerHTML = `${sessionStorage.plataforma}`
    spanNivel.innerHTML = `${sessionStorage.nivel}`
    spanData.innerHTML = `${sessionStorage.ultimaVisita}`
    document.getElementById('imgNivel').src = `../${sessionStorage.foto}`



    let labelsNivel = []
    let dadosNivel = []

    let labelsPlat = []
    let dadosPlat = []

    let chartNivel = document.getElementById('chartNivel');
    let chartPlataforma = document.getElementById('chartPlataforma');

    var graficoNivel = new Chart(chartNivel, {

        type: 'bar',

        data: {
            labels: labelsNivel,
            datasets: [{
                color: 'white',
                data: dadosNivel,
                borderWidth: 1,
                borderColor: '#1E1E1E',
                backgroundColor: ['#69bd63', '#69bd63', '#69bd63', '#69bd63']
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                    labels: {
                        color: 'white',
                        font: {
                            size: 10,
                            family: 'Noto Sans',
                        }
                    }
                }
            }
        }

    });

    var graficoPlataforma = new Chart(chartPlataforma, {
        type: 'bar',

        data: {
            labels: labelsPlat,
            datasets: [{
                color: 'white',
                data: dadosPlat,
                borderWidth: 1,
                borderColor: '#1E1E1E',
                backgroundColor: ['#428F4A', '#428F4A', '#428F4A', '#428F4A']
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                    labels: {
                        color: 'white',
                        font: {
                            size: 10,
                            family: 'Noto Sans',
                        }
                    }
                }
            }
        }

    });



    // VALIDAR SESSÃO



    // SAIR DA CONTA
    function logout() {

        atualizarVisita(Number(sessionStorage.idPlayer))
        toastr.info('<b> Até logo! :) </b>')

        window.location = "../index.html";
        sessionStorage.clear();

    }


    function like(idPlayer, idDica, idNivel) {

        fetch("/dicas/liked", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idPlayer: idPlayer,
                idDica: idDica,
                fkNivel: idNivel,
            })

        }).then(function (resposta) {

            console.log(resposta.status)
            if (resposta.status == 200) {


                window.location.reload()


            } else {
                toastr.warning(`<b style="font-family: Noto Sans; font-size: 14px">
                    Você já curtiu essa dica!
                </b>`)
            }


        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    }


    function atualizarDicas() {
        window.location.reload()
        listarDica(idSession, nivelSession)
    }


    function listarDica(idPlayer, idNivel) {

        fetch(`/dicas/listar/${idNivel}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idPlayer: idPlayer,
            })

        }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(function (dica) {

                    containerCard.innerHTML = ''

                    let count = 0
                    for (var i = 0; i < 2; i++) {

                        if (count < 4) {

                            let containerGroup = document.querySelector('#containerCard').getElementsByClassName('group-card')
                            containerCard.innerHTML += `<div class="group-card">`

                            for (var j = 0; j < 2; j++) {

                                containerGroup[i].innerHTML +=
                                    `
                                <div class="card">

                                    <div class="image">
                                        <img src="${dica[1][count].urlFoto}" alt="">
                                    </div>

                                    <div class="content">

                                        <div class="text">

                                            <div class="title">
                                                <h3>${dica[1][count].titulo}</h3>
                                            </div>

                                            <div class="desc">
                                                <p>${dica[1][count].descricao}</p>
                                            </div>

                                        </div>

                                        <div class="like">
                                            <div class="count-like">
                                                <p>${dica[1][count].qtdeLike} curtidas</p>
                                            </div>

                                            <div class="button-like">
                                                <a onclick="like(${idPlayer}, ${dica[1][count].idDica}, ${dica[1][count].fkNivel})" class="teste">              

                                                    <img src="../assets/icons/icon-coracao.png" alt="">

                                                </a>
                                            </div>

                                        </div>

                                    </div>

                                </div>
                               `

                                var linksFoto = document.getElementsByClassName('teste')
                                for (var c = 0; c < dica[0].length; c++) {

                                    if (dica[0][c].fkDica == dica[1][count].idDica) {

                                        linksFoto[count].innerHTML = `<img src="../assets/icons/icon-coracao-cheio.png" alt="">`

                                    }

                                }

                                count++

                            }

                            containerCard.innerHTML += '</div>'

                        } else {
                            console.log('saiu')
                            break
                        }


                    }

                });

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });


    }


    let qtdeTotal
    function playersTotal() {
        fetch(`/players/totalPlayers`, { cache: 'no-store' }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(function (total) {
                    qtdeTotal = total[0].qtde
                    totalPlayerBlog.innerHTML = `${total[0].qtde}`
                });

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }


    function dadosPlayersBlog() {

        playersTotal()

        fetch(`/players/listarNivel`, { cache: 'no-store' }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(function (qtdeNivel) {

                    console.log(qtdeNivel)

                    percCouro.innerHTML = `${((qtdeNivel[0].qtde * 100) / qtdeTotal).toFixed()}%`
                    percFerro.innerHTML = `${((qtdeNivel[1].qtde * 100) / qtdeTotal).toFixed()}%`
                    percDiamante.innerHTML = `${((qtdeNivel[2].qtde * 100) / qtdeTotal).toFixed()}%`
                    percNetherite.innerHTML = `${((qtdeNivel[3].qtde * 100) / qtdeTotal).toFixed()}%`

                    for (var i = 0; i < qtdeNivel.length; i++) {
                        labelsNivel.push(qtdeNivel[i].nomeNivel)
                        dadosNivel.push(qtdeNivel[i].qtde)
                    }
                });

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });




        fetch(`/players/listarPlataformas`, { cache: 'no-store' }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                resposta.json().then(function (qtdePlat) {

                    for (var j = 0; j < qtdePlat.length; j++) {
                        labelsPlat.push(qtdePlat[j].nomePlataforma)
                        dadosPlat.push(qtdePlat[j].qtde)
                    }

                });

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });


        setTimeout(() => {
            graficoNivel.update();
            graficoPlataforma.update();
        }, 5000)


    }


    function atualizarVisita(idPlayer) {

        fetch(`/players/ultimaVisita/${idPlayer}`, { cache: 'no-store' }).then(function (resposta) {

            console.log("resposta: ", resposta);

            if (resposta.ok) {

                console.log('Atualizado com sucesso')

            } else {
                throw ("Houve um erro ao tentar realizar o cadastro!");
            }

        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });

    }



</script>